<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Contacts - Administration - Franchini</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="css/admin-common.css">
    <style>
        .unread {
            font-weight: 500;
            background-color: #f8f9fa;
        }
        .contact-actions {
            white-space: nowrap;
        }
        .message-preview {
            max-height: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }
    </style>
</head>
<body>
    <!-- En-tête d'administration -->
    <div data-include="includes/admin-header.html"></div>

    <div class="admin-container">
        <!-- Navigation -->
        <div data-include="includes/admin-nav.html"></div>
        
        <div class="admin-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">Gestion des Contacts</h2>
                <div>
                    <button id="mark-all-read" class="btn btn-outline-secondary btn-sm me-2">
                        <i class="far fa-envelope-open me-1"></i> Tout marquer comme lu
                    </button>
                    <button id="export-contacts" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-file-export me-1"></i> Exporter
                    </button>
                </div>
            </div>
            
            <!-- Filtres -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="statut-filter" class="form-label">Statut</label>
                            <select class="form-select" id="statut-filter">
                                <option value="tous">Tous les messages</option>
                                <option value="non-lus">Non lus</option>
                                <option value="lus">Lus</option>
                                <option value="importants">Marqués importants</option>
                                <option value="archives">Archivés</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="categorie-filter" class="form-label">Catégorie</label>
                            <select class="form-select" id="categorie-filter">
                                <option value="">Toutes catégories</option>
                                <option value="demande-info">Demande d'information</option>
                                <option value="devis">Demande de devis</option>
                                <option value="sav">Service après-vente</option>
                                <option value="recrutement">Recrutement</option>
                                <option value="autre">Autre</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="search" class="form-label">Recherche</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="search" placeholder="Rechercher un contact...">
                                <button class="btn btn-outline-secondary" type="button">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button id="reset-filters" class="btn btn-outline-secondary w-100">
                                <i class="fas fa-undo me-1"></i> Réinitialiser
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Liste des contacts -->
            <div class="table-responsive">
                <table id="contacts-table" class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th width="40">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="select-all">
                                </div>
                            </th>
                            <th>Expéditeur</th>
                            <th>Sujet</th>
                            <th>Message</th>
                            <th>Date</th>
                            <th>Statut</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Les contacts seront chargés ici dynamiquement -->
                    </tbody>
                </table>
            </div>
            
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="text-muted small">
                    <span id="selected-count">0</span> sélectionné(s) sur <span id="total-count">0</span> message(s)
                </div>
                <div>
                    <button id="delete-selected" class="btn btn-sm btn-outline-danger me-2" disabled>
                        <i class="far fa-trash-alt me-1"></i> Supprimer
                    </button>
                    <button id="archive-selected" class="btn btn-sm btn-outline-secondary me-2" disabled>
                        <i class="fas fa-archive me-1"></i> Archiver
                    </button>
                    <button id="mark-read-selected" class="btn btn-sm btn-outline-primary" disabled>
                        <i class="far fa-envelope-open me-1"></i> Marquer comme lu
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de visualisation d'un message -->
    <div class="modal fade" id="view-message-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="message-subject">Sujet du message</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between mb-4">
                        <div>
                            <div class="fw-bold" id="sender-name">Prénom Nom</div>
                            <div class="text-muted small" id="sender-email">email@exemple.com</div>
                            <div class="text-muted small" id="sender-phone">+33 1 23 45 67 89</div>
                        </div>
                        <div class="text-end">
                            <div class="text-muted small" id="message-date">01/01/2023 14:30</div>
                            <div class="mt-2">
                                <button class="btn btn-sm btn-outline-secondary me-1" id="mark-important">
                                    <i class="far fa-star"></i> Important
                                </button>
                                <button class="btn btn-sm btn-outline-primary" id="reply-btn">
                                    <i class="fas fa-reply"></i> Répondre
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-body">
                            <div id="message-content">
                                Contenu du message...
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="message-files">
                        <!-- Pièces jointes -->
                    </div>
                    
                    <form id="reply-form" class="mt-4">
                        <div class="mb-3">
                            <label for="reply-content" class="form-label">Réponse</label>
                            <textarea class="form-control" id="reply-content" rows="4" placeholder="Votre réponse..." required></textarea>
                        </div>
                        <div class="d-flex justify-content-between">
                            <div>
                                <button type="button" class="btn btn-outline-secondary btn-sm me-2">
                                    <i class="fas fa-paperclip"></i> Joindre un fichier
                                </button>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="send-copy" checked>
                                    <label class="form-check-label" for="send-copy">M'envoyer une copie</label>
                                </div>
                            </div>
                            <div>
                                <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Annuler</button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane me-1"></i> Envoyer la réponse
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="js/admin-common.js"></script>
    <script>
        // Initialisation de la page
        document.addEventListener('DOMContentLoaded', function() {
            // Initialiser les composants communs
            if (typeof initPage === 'function') {
                initPage();
            }
            
            // Initialiser DataTable
            const table = $('#contacts-table').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/fr-FR.json'
                },
                order: [[4, 'desc']], // Trier par date décroissante par défaut
                pageLength: 25,
                responsive: true,
                columnDefs: [
                    { orderable: false, targets: [0, 6] },
                    { className: 'align-middle', targets: '_all' }
                ]
            });
            
            // Charger les contacts
            loadContacts();
            
            // Gestion de la sélection/désélection de toutes les lignes
            $('#select-all').on('change', function() {
                $('.contact-checkbox').prop('checked', this.checked);
                updateSelectionCount();
            });
            
            // Mettre à jour le compteur de sélection
            $('#contacts-table tbody').on('change', '.contact-checkbox', function() {
                updateSelectionCount();
            });
            
            // Bouton de suppression multiple
            $('#delete-selected').on('click', function() {
                if (confirm('Êtes-vous sûr de vouloir supprimer les messages sélectionnés ?')) {
                    // Logique de suppression
                    $('.contact-checkbox:checked').each(function() {
                        const row = $(this).closest('tr');
                        table.row(row).remove().draw();
                    });
                    updateSelectionCount();
                    
                    if (typeof showNotification === 'function') {
                        showNotification('Les messages sélectionnés ont été supprimés', 'success');
                    }
                }
            });
            
            // Bouton d'archivage multiple
            $('#archive-selected').on('click', function() {
                // Logique d'archivage
                $('.contact-checkbox:checked').each(function() {
                    const row = $(this).closest('tr');
                    row.addClass('table-secondary');
                });
                
                if (typeof showNotification === 'function') {
                    showNotification('Les messages sélectionnés ont été archivés', 'success');
                }
                
                updateSelectionCount();
            });
            
            // Bouton de marquage comme lu multiple
            $('#mark-read-selected').on('click', function() {
                // Logique de marquage comme lu
                $('.contact-checkbox:checked').each(function() {
                    const row = $(this).closest('tr');
                    row.removeClass('unread');
                    const statusCell = row.find('.status-cell');
                    statusCell.html('<span class="badge bg-success">Lu</span>');
                });
                
                updateSelectionCount();
            });
            
            // Marquer tous comme lus
            $('#mark-all-read').on('click', function() {
                $('.unread').removeClass('unread');
                $('.status-cell').html('<span class="badge bg-success">Lu</span>');
                
                if (typeof showNotification === 'function') {
                    showNotification('Tous les messages ont été marqués comme lus', 'success');
                }
            });
            
            // Exporter les contacts
            $('#export-contacts').on('click', function() {
                // Logique d'export
                if (typeof showNotification === 'function') {
                    showNotification('Export des contacts en cours de préparation...', 'info');
                }
                
                // Simulation d'export
                setTimeout(() => {
                    if (typeof showNotification === 'function') {
                        showNotification('Export terminé', 'success');
                    }
                }, 2000);
            });
            
            // Gestion des filtres
            $('#statut-filter, #categorie-filter, #search').on('change keyup', function() {
                table.draw();
            });
            
            // Réinitialiser les filtres
            $('#reset-filters').on('click', function() {
                $('#statut-filter').val('tous');
                $('#categorie-filter').val('');
                $('#search').val('');
                table.search('').columns().search('').draw();
            });
        });
        
        // Fonction pour charger les contacts
        function loadContacts() {
            // Ici, vous récupérerez les données depuis votre API ou base de données
            // Pour l'instant, on simule un chargement
            const contacts = [
                {
                    id: 1,
                    nom: 'Dupont',
                    prenom: 'Jean',
                    email: 'jean.dupont@exemple.com',
                    telephone: '06 12 34 56 78',
                    sujet: 'Demande de devis pour un tracteur',
                    message: 'Bonjour, je souhaiterais obtenir un devis pour un tracteur neuf. Pouvez-vous me contacter pour plus de détails ?',
                    date: '2023-06-15 14:30',
                    lu: false,
                    important: false,
                    categorie: 'devis'
                },
                // Ajoutez d'autres exemples si nécessaire
            ];
            
            const tbody = $('#contacts-table tbody');
            tbody.empty();
            
            if (contacts.length === 0) {
                tbody.append('<tr><td colspan="7" class="text-center py-4 text-muted">Aucun message trouvé</td></tr>');
                return;
            }
            
            contacts.forEach(contact => {
                const row = `
                    <tr class="${!contact.lu ? 'unread' : ''}">
                        <td>
                            <div class="form-check">
                                <input class="form-check-input contact-checkbox" type="checkbox" value="${contact.id}">
                            </div>
                        </td>
                        <td>
                            <div class="fw-bold">${contact.prenom} ${contact.nom}</div>
                            <div class="small text-muted">${contact.email}</div>
                        </td>
                        <td>${contact.sujet}</td>
                        <td class="message-preview" title="${contact.message.replace(/"/g, '&quot;')}">
                            ${contact.message.length > 50 ? contact.message.substring(0, 50) + '...' : contact.message}
                        </td>
                        <td class="text-nowrap">${formatDate(contact.date)}</td>
                        <td class="status-cell">
                            ${contact.lu ? '<span class="badge bg-success">Lu</span>' : '<span class="badge bg-warning text-dark">Non lu</span>'}
                        </td>
                        <td class="text-end contact-actions">
                            <button class="btn btn-sm btn-outline-primary view-message" data-id="${contact.id}" title="Voir le message">
                                <i class="far fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary ms-1" title="Marquer comme important">
                                <i class="far fa-star"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger ms-1" title="Supprimer">
                                <i class="far fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
            
            // Mettre à jour le compteur total
            $('#total-count').text(contacts.length);
            
            // Gestion du clic sur le bouton de visualisation
            $('.view-message').on('click', function() {
                const contactId = $(this).data('id');
                // Ici, vous récupérerez les détails complets du contact depuis votre API
                // Pour l'instant, on utilise les données déjà chargées
                const contact = contacts.find(c => c.id === contactId);
                if (contact) {
                    showContactDetails(contact);
                }
            });
            
            // Initialiser le DataTable
            if ($.fn.DataTable.isDataTable('#contacts-table')) {
                $('#contacts-table').DataTable().draw();
            }
        }
        
        // Fonction pour afficher les détails d'un contact
        function showContactDetails(contact) {
            $('#message-subject').text(contact.sujet);
            $('#sender-name').text(`${contact.prenom} ${contact.nom}`);
            $('#sender-email').text(contact.email);
            $('#sender-phone').text(contact.telephone || 'Non renseigné');
            $('#message-date').text(formatDate(contact.date, true));
            $('#message-content').text(contact.message);
            
            // Réinitialiser le formulaire de réponse
            $('#reply-form')[0].reset();
            
            // Afficher la modal
            const modal = new bootstrap.Modal(document.getElementById('view-message-modal'));
            modal.show();
            
            // Marquer comme lu
            if (!contact.lu) {
                contact.lu = true;
                const row = $(`button[data-id="${contact.id}"]`).closest('tr');
                row.removeClass('unread');
                row.find('.status-cell').html('<span class="badge bg-success">Lu</span>');
            }
        }
        
        // Fonction pour formater la date
        function formatDate(dateString, withTime = false) {
            const options = { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit',
                hour: withTime ? '2-digit' : undefined,
                minute: withTime ? '2-digit' : undefined
            };
            return new Date(dateString).toLocaleDateString('fr-FR', options);
        }
        
        // Fonction pour mettre à jour le compteur de sélection
        function updateSelectionCount() {
            const selectedCount = $('.contact-checkbox:checked').length;
            const totalCount = $('.contact-checkbox').length;
            
            $('#selected-count').text(selectedCount);
            $('#delete-selected, #archive-selected, #mark-read-selected')
                .prop('disabled', selectedCount === 0);
        }
    </script>
</body>
</html>
